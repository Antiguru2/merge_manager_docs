# ะะฑะทะพั ะฟัะพะตะบัะฐ merge_manager

## ๐ ะะฐะทะฒะฐะฝะธะต ะธ ะบัะฐัะบะพะต ะพะฟะธัะฐะฝะธะต

**merge_manager** โ ััะพ ะฟะตัะตะธัะฟะพะปัะทัะตะผัะน ะผะตัะฐะฝะธะทะผ ะพะฑัะตะดะธะฝะตะฝะธั ะดัะฑะปะธััััะธััั ะทะฐะฟะธัะตะน ะฒ Django-ะฟัะพะตะบัะฐั, ะบะพัะพััะน ะบะพะฝัะตะฝััะธััะตััั ะฝะฐ ัะพัะตัะฝัั ะพะฟะตัะฐัะธัั ยซะพะดะธะฝ ะฟัะธัะผะฝะธะบ + ะพะดะธะฝ ะดะพะฝะพัยป ั ัะพััะฐะฝะตะฝะธะตะผ ัะตะปะพััะฝะพััะธ ะดะฐะฝะฝัั ะธ ะฟัะพะทัะฐัะฝัะผ ะฐัะดะธัะพะผ.

## ๐ท๏ธ ะขะธะฟ ะฟัะพะตะบัะฐ

- **ะะฐัะตะณะพัะธั:** Django-ะฟัะธะปะพะถะตะฝะธะต (ะฟะพะดะผะพะดัะปั)
- **ะัะฝะพะฒะฝะพะน ัะทัะบ:** Python 3.10+
- **ะคัะตะนะผะฒะพัะบ:** Django 4.2
- **ะะฐะทะฐ ะดะฐะฝะฝัั:** SQLite/PostgreSQL (ะปัะฑะฐั ะฟะพะดะดะตัะถะธะฒะฐะตะผะฐั Django)

## ๐ง ะัะธะฝัะธะฟ ัะฐะฑะพัั

### ะะฑัะฐั ะบะพะฝัะตะฟัะธั

`merge_manager` ะฟัะตะดะพััะฐะฒะปัะตั ะดะตะบะปะฐัะฐัะธะฒะฝัะน ัะฟะพัะพะฑ ะพะฑัะตะดะธะฝะตะฝะธั ะดัะฑะปะธััััะธััั ะทะฐะฟะธัะตะน ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั. ะะผะตััะพ ัััะฝะพะณะพ ะฟะตัะตะฝะพัะฐ ะดะฐะฝะฝัั ะธ ัะฒัะทะตะน, ะฒั ะพะฟะธััะฒะฐะตัะต ะฟัะพัะธะปั ัะปะธัะฝะธั (merge profile), ัะบะฐะทัะฒะฐั ัััะฐัะตะณะธั ะดะปั ะบะฐะถะดะพะณะพ ะฟะพะปั, ะฐ ะดะฒะธะถะพะบ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒัะฟะพะปะฝัะตั ะฒัะต ะพะฟะตัะฐัะธะธ ั ัะพััะฐะฝะตะฝะธะตะผ ัะตะปะพััะฝะพััะธ ะดะฐะฝะฝัั.

### ะััะธัะตะบัััะฐ ะฝะฐ ะฒััะพะบะพะผ ััะพะฒะฝะต

ะัะพะตะบั ัะพััะพะธั ะธะท ัะตััััั ะพัะฝะพะฒะฝัั ัะปะพัะฒ:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         ะะพะฝัะธะณััะฐัะธะพะฝะฝัะน ัะปะพะน                   โ
โ  (config.py, settings.py, ะฟัะพัะธะปะธ ัะปะธัะฝะธั)      โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
โโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              ะกะตัะฒะธัะฝัะน ัะปะพะน                     โ
โ  (MergeService, ัััะฐัะตะณะธะธ ะฟะพะปะตะน, ะฟะตัะตะฝะพั ัะฒัะทะตะน)โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
โโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          ะกะปะพะน ะฟะตััะธััะตะฝัะฝะพััะธ                   โ
โ  (MergeOperation ะผะพะดะตะปั, Django ORM)            โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
โโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           ะะดะผะธะฝะธัััะฐัะธะฒะฝัะน ัะปะพะน                 โ
โ  (Django Admin ะดะปั ะฐัะดะธัะฐ ะพะฟะตัะฐัะธะน)             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะปััะตะฒัะต ะบะพะผะฟะพะฝะตะฝัั

#### 1. ะะพะฝัะธะณััะฐัะธะพะฝะฝัะน ัะปะพะน (`config.py`, `settings.py`)

ะัะฒะตัะฐะตั ะทะฐ:
- ะะตะณะธัััะฐัะธั merge-ะฟัะพัะธะปะตะน ะดะปั ะบะฐะถะดะพะน ะผะพะดะตะปะธ
- ะฅัะฐะฝะตะฝะธะต ัะตะตัััะฐ ัััะฐัะตะณะธะน ัะปะธัะฝะธั ะฟะพะปะตะน
- ะะฐะณััะทะบั ะฟะพะปัะทะพะฒะฐัะตะปััะบะธั ะฝะฐัััะพะตะบ ะธะท `MERGE_MANAGER_SETTINGS`
- ะะฝะฐัะตะฝะธั ะฟะพ ัะผะพะปัะฐะฝะธั (soft-delete ะฟะพะปะต, dry-run ัะตะถะธะผ)

**ะัะพัะธะปั ัะปะธัะฝะธั** โ ััะพ ะดะตะบะปะฐัะฐัะธะฒะฝะพะต ะพะฟะธัะฐะฝะธะต, ะบะฐะบ ะพะฑัะตะดะธะฝััั ะบะพะฝะบัะตัะฝัั ะผะพะดะตะปั. ะะบะปััะฐะตั:
- `label` โ ัะฝะธะบะฐะปัะฝัะน ะธะดะตะฝัะธัะธะบะฐัะพั ะฟัะพัะธะปั
- `model` โ ัะตะปะตะฒะฐั Django-ะผะพะดะตะปั
- `fields` โ ัะปะพะฒะฐัั ัััะฐัะตะณะธะน ะดะปั ะบะฐะถะดะพะณะพ ะฟะพะปั
- `soft_delete_field` โ ะฟะพะปะต ะดะปั ะผัะณะบะพะณะพ ัะดะฐะปะตะฝะธั ะดะพะฝะพัะฐ
- `pre_merge_hooks` / `post_merge_hooks` โ ััะบะธ ะดะปั ัะฐััะธัะตะฝะธั ะปะพะณะธะบะธ

#### 2. ะกะตัะฒะธัะฝัะน ัะปะพะน (`services/`)

**MergeService** (`services/merge.py`) โ ัะดัะพ ะปะพะณะธะบะธ ัะปะธัะฝะธั:
- ะะฐะณััะถะฐะตั ะฟัะพัะธะปั ะฟะพ label
- ะัะธะผะตะฝัะตั ัััะฐัะตะณะธะธ ะบ ะฟะพะปัะผ ะฟัะธัะผะฝะธะบะฐ ะธ ะดะพะฝะพัะฐ
- ะะตัะตะฝะพัะธั ะฒัะต FK ะธ M2M ัะฒัะทะธ ั ะดะพะฝะพัะฐ ะฝะฐ ะฟัะธัะผะฝะธะบะฐ
- ะัะฟะพะปะฝัะตั soft-delete ะดะพะฝะพัะฐ (ะธะปะธ hard-delete, ะตัะปะธ ัะบะฐะทะฐะฝะพ)
- ะกะพะทะดะฐัั ะทะฐะฟะธัั ะฐัะดะธัะฐ ะฒ `MergeOperation`

**ะกััะฐัะตะณะธะธ ะฟะพะปะตะน** (`services/strategies.py`) โ ะฝะฐะฑะพั ะณะพัะพะฒัั ะฟัะฐะฒะธะป:
- `prefer_target` โ ะพััะฐะฒะธัั ะทะฝะฐัะตะฝะธะต ะฟัะธัะผะฝะธะบะฐ
- `prefer_donor` โ ะฒะทััั ะทะฝะฐัะตะฝะธะต ะดะพะฝะพัะฐ
- `prefer_non_null` โ ะฒะทััั ะฝะตะฟัััะพะต ะทะฝะฐัะตะฝะธะต (ะฟัะธะพัะธัะตั ะฟัะธัะผะฝะธะบั)
- `concat` โ ะพะฑัะตะดะธะฝะธัั ัััะพะบะพะฒัะต ะทะฝะฐัะตะฝะธั ั ัะฐะทะดะตะปะธัะตะปะตะผ
- ะะพะปัะทะพะฒะฐัะตะปััะบะธะต ัััะฐัะตะณะธะธ (callable)

#### 3. ะกะปะพะน ะฐัะดะธัะฐ (`models.py`)

**MergeOperation** โ ะผะพะดะตะปั ะดะปั ััะฐะฝะตะฝะธั ะธััะพัะธะธ ัะปะธัะฝะธะน:
- ะกััะปะบะธ ะฝะฐ ะฟัะธัะผะฝะธะบะฐ ะธ ะดะพะฝะพัะฐ ัะตัะตะท ContentType
- ะัะฟะพะปัะทะพะฒะฐะฝะฝัะน ะฟัะพัะธะปั
- ะกะปะพะฒะฐัั ะธะทะผะตะฝัะฝะฝัั ะฟะพะปะตะน
- ะะฝัะพัะผะฐัะธั ะพ ะฟะตัะตะฝะตััะฝะฝัั ัะฒัะทัั
- ะกัะฐััั ะพะฟะตัะฐัะธะธ (`completed`, `dry_run`, `failed`)
- Timestamp ะธ ะดะพะฟะพะปะฝะธัะตะปัะฝัะต ะผะตัะฐะดะฐะฝะฝัะต

#### 4. ะะดะผะธะฝะธัััะฐัะธะฒะฝัะน ะธะฝัะตััะตะนั (`admin.py`)

Django Admin ะดะปั ะผะพะดะตะปะธ `MergeOperation`:
- ะัะพัะผะพัั ะธััะพัะธะธ ะฒัะตั ะพะฟะตัะฐัะธะน ัะปะธัะฝะธั
- ะคะธะปัััะฐัะธั ะฟะพ ะผะพะดะตะปัะผ, ััะฐัััะฐะผ, ะดะฐัะฐะผ
- ะะตัะฐะปะธะทะฐัะธั ะธะทะผะตะฝะตะฝะธะน ะฟะพ ะฟะพะปัะผ
- ะะฝััััะผะตะฝั ะดะปั data steward ะบะพะผะฐะฝะดั

### ะะธะทะฝะตะฝะฝัะน ัะธะบะป ะพะฟะตัะฐัะธะธ ัะปะธัะฝะธั

1. **ะัะฑะพั ะทะฐะฟะธัะตะน ะธ ะฟัะพัะธะปั**
   - ะะพะปัะทะพะฒะฐัะตะปั ะธะปะธ ะบะพะด ะพะฟัะตะดะตะปัะตั ะฟะฐัั: ะฟัะธัะผะฝะธะบ (target) ะธ ะดะพะฝะพั (donor)
   - ะฃะบะฐะทัะฒะฐะตั label ะฟัะพัะธะปั ัะปะธัะฝะธั

2. **ะะฐะณััะทะบะฐ ัััะฐัะตะณะธะน**
   - `MergeService` ะทะฐะณััะถะฐะตั ะฟัะพัะธะปั ะธะท ัะตะตัััะฐ
   - ะกะพะฑะธัะฐะตั ัััะฐัะตะณะธะธ ะดะปั ะฒัะตั ะฟะพะปะตะน ะผะพะดะตะปะธ
   - ะัะธะผะตะฝัะตั field_overrides, ะตัะปะธ ัะบะฐะทะฐะฝั

3. **Dry-run (ะพะฟัะธะพะฝะฐะปัะฝะพ)**
   - ะัะฟะพะปะฝัะตััั ะฟัะตะดะฟัะพัะผะพัั ะฑะตะท ะธะทะผะตะฝะตะฝะธะน ะฒ ะะ
   - ะะพะทะฒัะฐัะฐะตั MergeResult ัะพ ััะฐัััะพะผ `dry_run`
   - ะะพะบะฐะทัะฒะฐะตั, ะบะฐะบะธะต ะฟะพะปั ะฑัะดัั ะธะทะผะตะฝะตะฝั

4. **ะะตะฐะปัะฝะพะต ัะปะธัะฝะธะต**
   - ะัะธะผะตะฝััััั ัััะฐัะตะณะธะธ ะบ ะบะฐะถะดะพะผั ะฟะพะปั ะฟัะธัะผะฝะธะบะฐ
   - ะกะพััะฐะฝัะตััั ะพะฑะฝะพะฒะปัะฝะฝะฐั ะทะฐะฟะธัั ะฟัะธัะผะฝะธะบะฐ

5. **ะะตัะตะฝะพั ัะฒัะทะตะน**
   - ะัะต ForeignKey, ัะบะฐะทัะฒะฐััะธะต ะฝะฐ ะดะพะฝะพัะฐ, ะฟะตัะตะบะปััะฐัััั ะฝะฐ ะฟัะธัะผะฝะธะบะฐ
   - ะัะต ManyToMany ัะฒัะทะธ ะดะพะฝะพัะฐ ะฟะตัะตะฝะพััััั ะฝะฐ ะฟัะธัะผะฝะธะบะฐ

6. **Soft-delete ะดะพะฝะพัะฐ**
   - ะะพ ัะผะพะปัะฐะฝะธั ัััะฐะฝะฐะฒะปะธะฒะฐะตััั `is_active=False`
   - ะะปะธ hard-delete, ะตัะปะธ ัะบะฐะทะฐะฝะพ ะฒ ะฟัะพัะธะปะต

7. **ะัะดะธั**
   - ะกะพะทะดะฐัััั ะทะฐะฟะธัั ะฒ `MergeOperation`
   - ะกะพััะฐะฝัะตััั ัะฒะพะดะบะฐ ะธะทะผะตะฝะตะฝะธะน, ัะฒัะทะตะน ะธ ะผะตัะฐะดะฐะฝะฝัั

### ะะปััะตะฒัะต ะบะพะฝัะตะฟัะธะธ

#### ะกััะฐัะตะณะธะธ ัะปะธัะฝะธั ะฟะพะปะตะน

ะะฐะถะดะพะต ะฟะพะปะต ะผะพะดะตะปะธ ะผะพะถะตั ะธะผะตัั ัะฒะพั ัััะฐัะตะณะธั:

```python
"fields": {
    "name": {"strategy": "prefer_target"},      # ะััะฐะฒะธัั ะธะผั ะฟัะธัะผะฝะธะบะฐ
    "code": {"strategy": "prefer_non_null"},    # ะะทััั ะฝะตะฟัััะพะต ะทะฝะฐัะตะฝะธะต
    "description": {"strategy": "prefer_donor"}, # ะะทััั ะพะฟะธัะฐะฝะธะต ะดะพะฝะพัะฐ
    "tags": {"strategy": "concat", "separator": ", "} # ะะฑัะตะดะธะฝะธัั ัะตะณะธ
}
```

#### ะะตัะตะฝะพั ัะฒัะทะตะน

ะะฒัะพะผะฐัะธัะตัะบะธะน ะฟะตัะตะฝะพั ะฒัะตั ัะฒัะทะตะน:
- **ForeignKey**: ะฒัะต ะทะฐะฟะธัะธ, ัััะปะฐััะธะตัั ะฝะฐ ะดะพะฝะพัะฐ, ะฟะตัะตะบะปััะฐัััั ะฝะฐ ะฟัะธัะผะฝะธะบะฐ
- **ManyToMany**: ัะฒัะทะธ ะดะพะฝะพัะฐ ะดะพะฑะฐะฒะปััััั ะบ ะฟัะธัะผะฝะธะบั (ะฑะตะท ะดัะฑะปะตะน)

#### Soft-delete vs Hard-delete

ะะพ ัะผะพะปัะฐะฝะธั ะดะพะฝะพั ะฝะต ัะดะฐะปัะตััั ัะธะทะธัะตัะบะธ, ะฐ ะฟะพะผะตัะฐะตััั ะฟะพะปะตะผ `is_active=False`. ะญัะพ ะฟะพะทะฒะพะปัะตั:
- ะกะพััะฐะฝะธัั ะธััะพัะธั
- ะัะบะฐัะธัั ะพะฟะตัะฐัะธั ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ
- ะกะพะฑะปัััะธ ััะตะฑะพะฒะฐะฝะธั ะฐัะดะธัะฐ

#### Dry-run ัะตะถะธะผ

ะะพะทะฒะพะปัะตั ะฟัะตะดะฟัะพัะผะพััะตัั ัะตะทัะปััะฐั ัะปะธัะฝะธั ะฑะตะท ะธะทะผะตะฝะตะฝะธะน ะฒ ะะ. ะะพะปะตะทะฝะพ ะดะปั:
- UI ะฟัะตะดะฟัะพัะผะพััะฐ ะฟะตัะตะด ะฟะพะดัะฒะตัะถะดะตะฝะธะตะผ
- ะะฐะปะธะดะฐัะธะธ ะฟัะพัะธะปะตะน
- ะขะตััะธัะพะฒะฐะฝะธั ัััะฐัะตะณะธะน

## ๐งญ ะะพะฝัะตะบัั ะฒ ัะบะพัะธััะตะผะต

- ะะพะดะบะปััะฐะตััั ะบะฐะบ ะฟะพะดะผะพะดัะปั ะฒ ะพัะฝะพะฒะฝะพะน ะฟัะพะตะบั `cargo_calc`
- ะะฐะฑะพัะฐะตั ะฟะพะฒะตัั Django ORM ะธ ะผะพะถะตั ะธัะฟะพะปัะทะพะฒะฐัััั ะดััะณะธะผะธ ััะฑะผะพะดัะปัะผะธ (ะฝะฐะฟัะธะผะตั, `data_connector`, `price_manager`) ะดะปั ะฝะฐะฒะตะดะตะฝะธั ะฟะพััะดะบะฐ ะฒ ัะฟัะฐะฒะพัะฝะธะบะฐั
- ะัะตะดะพััะฐะฒะปัะตั ะถััะฝะฐะป ะพะฟะตัะฐัะธะน, ะดะพัััะฟะฝัะน ัะตัะตะท Django Admin, ััะพ ัะฟัะพัะฐะตั ะฒะทะฐะธะผะพะดะตะนััะฒะธะต ั data steward ะบะพะผะฐะฝะดะพะน

## ๐ ะขะตะบััะธะน ััะฐััั ะฒะพะทะผะพะถะฝะพััะตะน

| ะะพะทะผะพะถะฝะพััั | ะกัะฐััั |
|-------------|--------|
| Merge ยซ1 ะฟัะธัะผะฝะธะบ + 1 ะดะพะฝะพัยป | โ ะะตะฐะปะธะทะพะฒะฐะฝะพ |
| ะะตัะตะฝะพั FK / M2M ัะฒัะทะตะน | โ ะะตะฐะปะธะทะพะฒะฐะฝะพ |
| Soft-delete ะดะพะฝะพัะฐ | โ ะะตะฐะปะธะทะพะฒะฐะฝะพ |
| Dry-run ัะตะถะธะผ | โ ะะตะฐะปะธะทะพะฒะฐะฝะพ |
| ะะฐัััะฐะธะฒะฐะตะผัะต ัััะฐัะตะณะธะธ ะฟะพะปะตะน | โ ะะตะฐะปะธะทะพะฒะฐะฝะพ |
| ะััะฝะฐะป ะฐัะดะธัะฐ (MergeOperation) | โ ะะตะฐะปะธะทะพะฒะฐะฝะพ |
| Django Admin UI ะดะปั ะฐัะดะธัะฐ | โ ะะตะฐะปะธะทะพะฒะฐะฝะพ |
| REST API | โณ ะ ะฟะปะฐะฝะฐั |
| UI ะดะปั ะฒัะฑะพัะฐ ะทะฐะฟะธัะตะน | โณ ะ ะฟะปะฐะฝะฐั |
| Fuzzy matching ะบะฐะฝะดะธะดะฐัะพะฒ | โณ ะ ะธััะปะตะดะพะฒะฐะฝะธัั |
| ะัะปััะธ-ะดะพะฝะพัั (Nโ1) | โณ ะ ะฑัะบะปะพะณะต |

## โ๏ธ ะะณัะฐะฝะธัะตะฝะธั ะธ ัะธัะบะธ

- **ะััะฝะพะน ะฒัะฑะพั ะทะฐะฟะธัะตะน:** ะัะถะฝะฐ ัััะฝะฐั ัะตะณะธัััะฐัะธั ะฟัะพัะธะปะตะน ะธ ัััะฝะพะน ะฒัะฑะพั ะบะฐะฝะดะธะดะฐัะพะฒ ะดะปั ัะปะธัะฝะธั
- **Soft-delete ััะตะฑะพะฒะฐะฝะธะต:** ะะปั ะบะพััะตะบัะฝะพะน ัะฐะฑะพัั ััะตะฑัะตััั ะฐะบััะฐะปัะฝะพะต ะฟะพะปะต soft-delete ะฒ ะผะพะดะตะปัั ะดะพะผะตะฝะฐ
- **ะัะพัััะต ััะตะฝะฐัะธะธ:** ะกะตัะฒะธั ะฟะพะบะฐ ะฝะต ะพะฑัะฐะฑะฐััะฒะฐะตั ะบะฐัะบะฐะดะฝัะต ััะตะฝะฐัะธะธ ั ะฝะตัะบะพะปัะบะธะผะธ ะดะพะฝะพัะฐะผะธ ะธะปะธ ะฒะฝะตัะฝะธะผะธ ัะธััะตะผะฐะผะธ ะพัะตัะตะดะตะน
- **ะะตะทะพะฟะฐัะฝะพััั ััะฐะฝะทะฐะบัะธะน:** ะัะต ะพะฟะตัะฐัะธะธ ะฒัะฟะพะปะฝััััั ะฒ ะพะดะฝะพะน ััะฐะฝะทะฐะบัะธะธ, ััะพ ะผะพะถะตั ะฑััั ะบัะธัะธัะฝะพ ะดะปั ะฑะพะปััะธั ะพะฑััะผะพะฒ ะดะฐะฝะฝัั

## ๐ ะกะฒัะทะฐะฝะฝัะต ะดะพะบัะผะตะฝัั

- [ะัััััะน ััะฐัั](QUICKSTART.md) โ ัััะฐะฝะพะฒะบะฐ ะธ ะฟะตัะฒัะน ะทะฐะฟััะบ
- [API ะดะพะบัะผะตะฝัะฐัะธั](API.md) โ ะธัะฟะพะปัะทะพะฒะฐะฝะธะต MergeService
- [ะััะพัะธั ะธะทะผะตะฝะตะฝะธะน](CHANGELOG.md) โ ัะฟะธัะพะบ ะฒะตััะธะน ะธ ะธะทะผะตะฝะตะฝะธะน

