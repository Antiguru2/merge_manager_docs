# Обзор проекта merge_manager

## 📌 Название и краткое описание

**merge_manager** — это переиспользуемый механизм объединения дублирующихся записей в Django-проектах, который концентрируется на точечных операциях «один приёмник + один донор» с сохранением целостности данных и прозрачным аудитом.

## 🏷️ Тип проекта

- **Категория:** Django-приложение (подмодуль)
- **Основной язык:** Python 3.10+
- **Фреймворк:** Django 4.2
- **База данных:** SQLite/PostgreSQL (любая поддерживаемая Django)

## 🔧 Принцип работы

### Общая концепция

`merge_manager` предоставляет декларативный способ объединения дублирующихся записей в базе данных. Вместо ручного переноса данных и связей, вы описываете профиль слияния (merge profile), указывая стратегию для каждого поля, а движок автоматически выполняет все операции с сохранением целостности данных.

### Архитектура на высоком уровне

Проект состоит из четырёх основных слоёв:

```
┌─────────────────────────────────────────────────┐
│         Конфигурационный слой                   │
│  (config.py, settings.py, профили слияния)      │
└─────────────────┬───────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────┐
│              Сервисный слой                     │
│  (MergeService, стратегии полей, перенос связей)│
└─────────────────┬───────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────┐
│          Слой персистентности                   │
│  (MergeOperation модель, Django ORM)            │
└─────────────────┬───────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────┐
│           Административный слой                 │
│  (Django Admin для аудита операций)             │
└─────────────────────────────────────────────────┘
```

### Ключевые компоненты

#### 1. Конфигурационный слой (`config.py`, `settings.py`)

Отвечает за:
- Регистрацию merge-профилей для каждой модели
- Хранение реестра стратегий слияния полей
- Загрузку пользовательских настроек из `MERGE_MANAGER_SETTINGS`
- Значения по умолчанию (soft-delete поле, dry-run режим)

**Профиль слияния** — это декларативное описание, как объединять конкретную модель. Включает:
- `label` — уникальный идентификатор профиля
- `model` — целевая Django-модель
- `fields` — словарь стратегий для каждого поля
- `soft_delete_field` — поле для мягкого удаления донора
- `pre_merge_hooks` / `post_merge_hooks` — хуки для расширения логики

#### 2. Сервисный слой (`services/`)

**MergeService** (`services/merge.py`) — ядро логики слияния:
- Загружает профиль по label
- Применяет стратегии к полям приёмника и донора
- Переносит все FK и M2M связи с донора на приёмника
- Выполняет soft-delete донора (или hard-delete, если указано)
- Создаёт запись аудита в `MergeOperation`

**Стратегии полей** (`services/strategies.py`) — набор готовых правил:
- `prefer_target` — оставить значение приёмника
- `prefer_donor` — взять значение донора
- `prefer_non_null` — взять непустое значение (приоритет приёмнику)
- `concat` — объединить строковые значения с разделителем
- Пользовательские стратегии (callable)

#### 3. Слой аудита (`models.py`)

**MergeOperation** — модель для хранения истории слияний:
- Ссылки на приёмника и донора через ContentType
- Использованный профиль
- Словарь изменённых полей
- Информация о перенесённых связях
- Статус операции (`completed`, `dry_run`, `failed`)
- Timestamp и дополнительные метаданные

#### 4. Административный интерфейс (`admin.py`)

Django Admin для модели `MergeOperation`:
- Просмотр истории всех операций слияния
- Фильтрация по моделям, статусам, датам
- Детализация изменений по полям
- Инструмент для data steward команды

### Жизненный цикл операции слияния

1. **Выбор записей и профиля**
   - Пользователь или код определяет пару: приёмник (target) и донор (donor)
   - Указывает label профиля слияния

2. **Загрузка стратегий**
   - `MergeService` загружает профиль из реестра
   - Собирает стратегии для всех полей модели
   - Применяет field_overrides, если указаны

3. **Dry-run (опционально)**
   - Выполняется предпросмотр без изменений в БД
   - Возвращает MergeResult со статусом `dry_run`
   - Показывает, какие поля будут изменены

4. **Реальное слияние**
   - Применяются стратегии к каждому полю приёмника
   - Сохраняется обновлённая запись приёмника

5. **Перенос связей**
   - Все ForeignKey, указывающие на донора, переключаются на приёмника
   - Все ManyToMany связи донора переносятся на приёмника

6. **Soft-delete донора**
   - По умолчанию устанавливается `is_active=False`
   - Или hard-delete, если указано в профиле

7. **Аудит**
   - Создаётся запись в `MergeOperation`
   - Сохраняется сводка изменений, связей и метаданных

### Ключевые концепции

#### Стратегии слияния полей

Каждое поле модели может иметь свою стратегию:

```python
"fields": {
    "name": {"strategy": "prefer_target"},      # Оставить имя приёмника
    "code": {"strategy": "prefer_non_null"},    # Взять непустое значение
    "description": {"strategy": "prefer_donor"}, # Взять описание донора
    "tags": {"strategy": "concat", "separator": ", "} # Объединить теги
}
```

#### Перенос связей

Автоматический перенос всех связей:
- **ForeignKey**: все записи, ссылающиеся на донора, переключаются на приёмника
- **ManyToMany**: связи донора добавляются к приёмнику (без дублей)

#### Soft-delete vs Hard-delete

По умолчанию донор не удаляется физически, а помечается полем `is_active=False`. Это позволяет:
- Сохранить историю
- Откатить операцию при необходимости
- Соблюсти требования аудита

#### Dry-run режим

Позволяет предпросмотреть результат слияния без изменений в БД. Полезно для:
- UI предпросмотра перед подтверждением
- Валидации профилей
- Тестирования стратегий

## 🧭 Контекст в экосистеме

- Подключается как подмодуль в основной проект `cargo_calc`
- Работает поверх Django ORM и может использоваться другими субмодулями (например, `data_connector`, `price_manager`) для наведения порядка в справочниках
- Предоставляет журнал операций, доступный через Django Admin, что упрощает взаимодействие с data steward командой

## 📌 Текущий статус возможностей

| Возможность | Статус |
|-------------|--------|
| Merge «1 приёмник + 1 донор» | ✅ Реализовано |
| Перенос FK / M2M связей | ✅ Реализовано |
| Soft-delete донора | ✅ Реализовано |
| Dry-run режим | ✅ Реализовано |
| Настраиваемые стратегии полей | ✅ Реализовано |
| Журнал аудита (MergeOperation) | ✅ Реализовано |
| Django Admin UI для аудита | ✅ Реализовано |
| REST API | ⏳ В планах |
| UI для выбора записей | ⏳ В планах |
| Fuzzy matching кандидатов | ⏳ В исследованиях |
| Мульти-доноры (N→1) | ⏳ В бэклоге |

## ⚠️ Ограничения и риски

- **Ручной выбор записей:** Нужна ручная регистрация профилей и ручной выбор кандидатов для слияния
- **Soft-delete требование:** Для корректной работы требуется актуальное поле soft-delete в моделях домена
- **Простые сценарии:** Сервис пока не обрабатывает каскадные сценарии с несколькими донорами или внешними системами очередей
- **Безопасность транзакций:** Все операции выполняются в одной транзакции, что может быть критично для больших объёмов данных

## 🔗 Связанные документы

- [Быстрый старт](QUICKSTART.md) — установка и первый запуск
- [API документация](API.md) — использование MergeService
- [История изменений](CHANGELOG.md) — список версий и изменений

