# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ merge_manager

## üìã –ü—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏
- Python 3.10+
- Django 4.2 (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏ Cargo Calc)
- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `django.contrib.contenttypes`, `django.contrib.admin`
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (SQLite –ø–æ–¥–æ–π–¥—ë—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞ Cargo Calc

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
```bash
pip install -r req.txt
```

### 2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```python
# cargo_calc/settings.py
INSTALLED_APPS = [
    # ...
    'merge_manager',
]
```

### 3. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
python manage.py migrate merge_manager
```

### 4. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
```python
MERGE_MANAGER_SETTINGS = {
    "PROFILES": [],  # –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—è–º–∏ (—Å–º. –Ω–∏–∂–µ)
    "DRY_RUN_DEFAULT": False,
    "SOFT_DELETE_FIELD": "is_active",
    "SOFT_DELETE_VALUE": False,
}
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π
–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –º–æ–¥–µ–ª–∏ `main.City`:
```python
MERGE_MANAGER_SETTINGS["PROFILES"].append({
    "label": "city",
    "model": "main.City",
    "fields": {
        "name": {"strategy": "prefer_target"},
        "code": {"strategy": "prefer_non_null"},
        "population": {"strategy": "prefer_donor"},
    },
})
```

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª—é—á–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
| –ö–ª—é—á | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------------|----------|
| `label` | ‚úÖ | –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –ø—Ä–æ—Ñ–∏–ª—è |
| `model` | ‚úÖ | Django –º–æ–¥–µ–ª—å –∏–ª–∏ –ø—É—Ç—å `app.Model` |
| `fields` | ‚úÖ | –ü—Ä–∞–≤–∏–ª–∞ –ø–æ –ø–æ–ª—è–º (`FieldMergeRule`) |
| `soft_delete_field` | ‚ùå | –ò–º—è –ø–æ–ª—è –¥–ª—è soft-delete (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `is_active`) |
| `soft_delete_value` | ‚ùå | –ó–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–æ–Ω–æ—Ä—É |
| `hard_delete` | ‚ùå | –ü—Ä–∏ `True` –¥–æ–Ω–æ—Ä —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –±–∞–∑—ã –ø–æ—Å–ª–µ —Å–ª–∏—è–Ω–∏—è |
| `pre_merge_hooks` | ‚ùå | –°–ø–∏—Å–æ–∫ callables –¥–æ —Å–ª–∏—è–Ω–∏—è |
| `post_merge_hooks` | ‚ùå | –°–ø–∏—Å–æ–∫ callables –ø–æ—Å–ª–µ —Å–ª–∏—è–Ω–∏—è |

### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–≤–æ–π—Å—Ç–≤–æ –∏–ª–∏ –º–µ—Ç–æ–¥ `admin_change_url`.
- –ï—Å–ª–∏ —Å–≤–æ–π—Å—Ç–≤–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∏–∫–æ–Ω–∫–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –∞ –ø–æ–∏—Å–∫–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –≤–µ—Ä–Ω—É—Ç `admin_change_url = null`.
- –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å mixin `AdminChangeButtonMixin` (—Å–º. `data_connector/submodules/base_content_objects/mixins.py`) –ª–∏–±–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–µ–µ `reverse('admin:app_model_change', args=[pk])`.

## üß∞ –ü–æ–ª–µ–∑–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Django –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
```bash
python manage.py check
python manage.py test merge_manager
```
–ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç, –∞ —Ç–∞–±–ª–∏—Ü–∞ `merge_manager_mergeoperation` –ø–æ—è–≤–∏–ª–∞—Å—å –≤ –ë–î, –º–æ–¥—É–ª—å –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.

## ‚ùå –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
| –°–∏–º–ø—Ç–æ–º | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|---------|---------|---------|
| `ModuleNotFoundError: merge_manager` | –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –≤ `INSTALLED_APPS` | –î–æ–±–∞–≤—å—Ç–µ `merge_manager` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä |
| `FieldDoesNotExist` –ø—Ä–∏ soft-delete | –í –º–æ–¥–µ–ª–∏ –Ω–µ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—è | –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ `soft_delete_field` –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ –≤ –º–æ–¥–µ–ª—å |
| –°—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ | –û–ø–µ—á–∞—Ç–∫–∞ –≤ –∫–ª—é—á–µ `strategy` | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ `FIELD_STRATEGIES` |

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞
- –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –∫–∞–Ω–∞–ª `#cargo-calc-dev`
- –û—à–∏–±–∫–∏ –≤ –º–∏–≥—Ä–∞—Ü–∏—è—Ö ‚Äî –∫–æ–º–∞–Ω–¥–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- –£–ª—É—á—à–µ–Ω–∏—è –∏ –∏–¥–µ–∏ ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–ø–∏—Å—å –≤ [–±–∞–Ω–∫–µ –∏–¥–µ–π](ideas/README.md)
